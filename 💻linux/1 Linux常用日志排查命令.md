# 1 Linux常用日志排查命令

以前学习Linux的时候都是在瞎玩，没有真正去研究一些命令和命令的参数。现在就以生产日志查询的角度去学习一些基本的命令，需要什么就学什么。一般来说，生产的服务器我们都是通过跳板机去连接，而不能直接连接。



一般来说我们的命令都是这样的形式：

```
command [options] [arguments] options选项，arguments参数
```



## 1. 准备

第一步就是连接跳板机，可以用工具，也可以直接在web上去连接。



## 2. 开始

接着我们就是找到对应日志的位置。**如果你不知道日志存储的位置，在Java项目中，都会配置自己的日志存储路径，如果是用log4j2的话，你应该可以到对应的配置文件(log4j2.xml)，找到日志存储的位置。**

如果你不懂命令，或者想了解更多，可以来这里：[Linux命令手册](https://git.io/linux)、linux教程 | 菜鸟教程



然后就是开始一顿操作了

- pwd: print working directory 首先我们可以查看自己所在的当前路径，当前目录
- whereis: 当然你也可以通过这个命令查找文件所在位置



- cd: change directory 接着进入到对应的目录下，在这里可以使用绝对路径|相对路径

- options:

- . 当前目录

- .. 上级目录

- ~ 用户主目录

- \- 返回此目录之前的所在的目录

- / 根目录

  

- ls: list directory content 如果我们不知道当前目录下有什么，我们就可以用这个命令列出

- options:

- -a 隐藏的文件也会列出来

- -l 所有输出信息用单列的格式输出，而不是多列，一般我们用这个就看看文件的修改时间、大小

- -t 最近修改的文件显示在最上面，这个还是很有用的，但文件比较多的时候好用。

- --color=auto 列出文件并标记颜色分类



### 2.1 重要

当我们定位到日志目录时，这才是真正开始查询日志。vi这个是比较特殊的，所以先讲。虽然我们查询日志的时候几乎用不到这个命令，这个命令是用于编辑文件的。在linux中用的是vim，我也是用这个。

要想使用vi，首先就需要了解其工作模式：命令模式、编辑模式、末行模式

![image.png](images/vim.png)



基本上了解上面的一些就ok，另外就是如何编辑和退出。当一开始进入的时候是**命令模式**，接着我们可以按下键盘上的**iao**任意一个，就会进入到编辑模式了。编辑完后，我们可以看**ESC**回到命令模式，最后输入**：**进入到末行模式，也就是上图的底线命令模式，最后输入**wq!**保存退出即可。

- :! 强制
- :w 保存
- :q 退出
- :q!强制退出
- :wq!



上面的简单了解先即可，接下来才是我们查询日志。在linux系统终端模式下，我们是没有图形界面去给你直接点开文件，一个个去浏览的。因此我们第一个问题就是：如果查看文件内容？

上诉所讲的vi也是可以的，但是对我们来说使用太不友好了。下面就是我们用到的一些用于查看的命令。在学习之前我们可以先想一下我们有什么需求：首先我们希望可以去搜索关键字，其次最好颜色也像上面一样可以标记颜色，最后可以看看查询内容的上下文。Ok，下面你的问题都将会得到解答。



### 2.2 grep

**G**lobal search **R**egular **E**xpression(RE) and **P**rint out the line(全面搜索正则表达式并把行打印出来)

- grep/zgrep:
- grep "match_pattern" file_name 在文件中搜索一个单词
- options:
-    --color=auto 标记匹配颜色(这个很舒服啊，这样我们就能快速找到我们要查询的内容了)
-    -E 使用正则表达式(这个应该和上面的搜索单词区分)
-    -c 统计单词出现的次数
-    -n 输出匹配字符的行数(终于等到你，这个应该会很有用吧)
-    -i 忽略大小写
-    -A 除了显示符合范本样式的那一行之外，并显示该行之后的内容。
-    -B 除了显示符合范本样式的那一行之外，并显示该行之前的内容
-    -C 除了显示符合范本样式的那一行之外，并显示该行前后后的内容



这个ABC可谓是神器，因为有时候我们不仅是想看到符合的内容，**还想看到其上下文，这时候就得借助ABC选项了。**

```
例如：grep "aes-256-gcm" shadowsocks.log -A 2
```

另外支持正则查询，例如：查询超时

```
cat /usr/local/logs/requestTime.log | grep -E "ing:[0-9]{4,}" -C 5
```

 

### 2.3 tail

- tail file (默认显示文件file的最后10行)
- tail +20 file (显示文件file的内容，从第20行至文件末尾)
- tail -c 10 file （显示文件file的最后10个字符）
- tail:
- options:
- -f 显示文件最新追加的内容**（显示文件最新追加的内容**，这个选项在外面**启动项目**的时候很方便，因为我们启动的项目的时候日志是一点点打印的，这个时候我们就看到日志一点点输出，不用每次tail查看后面的10行。）
- -n 输出文件的尾部N（N位数字）行内容 （有时候我们并不想从第几行开始到尾部，也不下追加内容显示，我们只想显示后面的多少行内容。那么这个选项就很好的满足了你的需求。）



### 2.4 head

- head:
- options:
- -n 输出文件的头部N（N位数字）行内容
- 其实-n的这个选项，基本上就是用来代码行的，在tail和head命令中我们发现他们是一样的效果。



### 2.5 cat/zcat

为了控制滚屏，可以按Ctrl+S键，停止滚屏；按Ctrl+Q键可以恢复滚屏。按Ctrl+C（中断）键可以终止该命令的执行，并且返回Shell提示符状态。

管道： | 



### 2.6 more

**more命令**是一个基于[vi](http://man.linuxde.net/vi)编辑器文本过滤器，它以全屏幕的方式按页显示文本文件的内容，支持vi中的关键字定位操作。more名单中内置了若干快捷键，常用的有H（获得帮助信息），**Enter（向下翻滚一行），空格（向下滚动一屏）**，Q（退出命令）。

基本上上面所列出的命令已经足够我们查看日志了。



### 2.7 top

当然除了查看文件，我们可能还需要看一些进程



实时查看系统运行状态

- -b：以批处理模式操作
- -c：显示完整的治命令
- -d：屏幕刷新间隔时间
- -I：忽略失效过程
- -s：保密模式
- -S：累积模式
- -i<时间>：设置间隔时间
- -u<用户名>：指定用户名
- -p<进程号>：指定进程(必备)
- -n<次数>：循环显示的次数

在top命令执行过程中可以使用的一些交互命令。这些命令都是单字母的，如果在命令行中使用了-s选项， 其中一些命令可能会被屏蔽。

输入top，然后按对应的键即可。**Ctrl+C停止太low了，试试按q直接退出。**

- h：显示帮助画面，给出一些简短的命令总结说明
- k：终止一个进程
- i：忽略闲置和僵死进程，这是一个开关式命令
- q：退出程序
- r：重新安排一个进程的优先级别
- S：切换到累计模式
- s：改变两次刷新之间的延迟时间（单位为s），如果有小数，就换算成ms。输入0值则系统将不断刷新，默认值是5s
- f或者F：从当前显示中添加或者删除项目
- o或者O：改变显示项目的顺序
- l：切换显示平均负载和启动时间信息
- m：切换显示内存信息
- t：切换显示进程和CPU状态信息
- c：切换显示命令名称和完整命令行
- M：根据驻留内存大小进行排序
- P：根据CPU使用百分比大小进行排序
- T：根据时间/累计时间进行排序
- w：将当前设置写入~/.toprc文件中
- 1：数字1能够查看CPU信息，当然也可以看到是几核



### 2.8 ps

- ps -aux是以BSD方式列出当前全部运行的进程
- ps -ef是以system v方式列出当前全部运行的进程
- 上面两个命令虽然显示的都是当前全部运行进程，但是ps -aux列出的条目更多
- ps -axj 列出守护进程
- **ps -ef | grep init 查找当前运行进程中的的init进程**
- ps -l 列出ps中的进程操作命令及编号，例如kill等
- **ps -ef | grep init 查找当前运行进程中的的init进程**



### 2.9 kill

用来删除执行中的程序或工作，生产上要是删除了，怕是要跑路了？

- -a：当处理当前进程时，不限制命令名和进程号的对应关系；
- -l <信息编号>：若不加<信息编号>选项，则-l参数会列出全部的信息名称；
- -p：指定kill 命令只打印相关进程的进程号，而不发送任何信号；
- -s <信息名称或编号>：指定要送出的信息；
- -u：指定用户。



### 2.10 上传下载文件

有时候你也可能需要下载文件，可以用下面两个命令。

- rz 上传文件命令
- sz 下载文件到本地



### 2.11 查看系统存储情况

1. df命令可以显示目前所有文件系统的可用空间及使用情形
2. du：查询文件或文件夹的磁盘使用空间

```
df -h du -h --max-depth=1 ./
```



### 2.12 awk

awk是一个强大的文本分析工具，相对于grep的查找，sed的编辑，awk在其对数据分析并生成报告时，显得尤为强大。

```
awk '{print $2}'
```



### 2.13 ping

将ICMP ECHO_REQUEST数据包发送到网络主机



### 2.14 curl



### 2.15 traceroute

traceroute跟踪从IP网络获取到给定主机的**路由信息包**。它利用IP协议的生存时间（TTL）字段并尝试从每个网关到主机的路径引发ICMP TIME_EXCEEDED响应。



**2.16 wget**

GNU Wget是一个免费实用程序，用于从Web非交互式下载文件。它支持HTTP，HTTPS和FTP协议，以及通过HTTP代理进行检索。



### 2.17 free

free显示系统中可用和可用的物理内存和交换内存的总量，以及内核使用的缓冲区和高速缓存。



## 3. 总结

上面的命令只是帮助我们查询，一般来说，我们去查询的时候，先定位一下是哪一个服务器上出了问题，连接上对应服务器，找到对应的日志存储位置。

**接着通过唯一的id去查找，找到对应的id相关信息之后，通过该id所在的线程id去查找。**

日志的打印格式(**Pattern**)可以在log4j2.xml配置文件下找

```
2019-08-31 00:00:00.414 ERROR [SimpleAsyncTaskExecutor-1] 1e1111c8-1bf4-4e2c-af43-db0bda2ba85c 后面的没有列出来

日期——线程名——线程ID
```



**在这里要看是异步线程，还是同步线程，还是多线程，不然你可能通过该线程id找不到对应的日志错误信息。如果没有线程id，那就只能通过线程名称了**

其次，如果是mq的消息，你可以先找到mq消费的**messageId**，接着通过该messageId找到更多的信息。



log4j2.xml日志文件大小达到一定的数量，你就只能到压缩文件查看了，用zgrep命令。不然你可能一直很奇怪为什么查不到信息。

**坑：当遇到一个错误信息的时候，你可以看看代码，然后通过版本控制器看看是不是最近有人改了代码，然后找出来暴打问一顿。（笑）**



**补充：还可以根据方法的名称去搜索error.log信息**