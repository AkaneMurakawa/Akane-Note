# 重要的日志

详细内容见[MySQL架构.pdf]



在 MySQL 里，如果每一次的更新操作都需要写进磁盘，然后磁盘也要找到对应的那条记录，然后再更新，整个过程 IO 成本、查找成本都很高。为了解决这个问题，MySQL 的设计者就用了类似**酒店掌柜粉板**的思路来提升更新效率。



> 一个有趣而通俗的例子，你是一个酒店老板，来的客户点餐需要记账。一开始你只记在账本里，然后发现人多的时候就忙不过来了。
>
> 这时候，你加了一块黑板，先记在黑板上，等有空的时候再记到账本里。



## WAL (Write-Ahead-Logging)

MySQL 里经常说到的 WAL 技术，WAL 的全称是 Write-Ahead Logging，**它的关键点就是先写日志，再写磁盘**，也就是先写粉板，等不忙的时候再写账本。



## 重要日志

- Redo Log（重做日志）
- Bin Log （归档日志）
- Undo Log



### Redo Log（重做日志）

就像上面例子中的黑板，黑板的大小是固定，与此类似Redo Log是**固定大小**的，比如可以配置为一组 4 个文件，每个文件的大小是 1GB，那么这块“粉板”总共就可以记录 4GB 的操作。从头开始写，写到末尾就又回到开头循环写，**是循环写的过程.**

![redolog.png](D:/Note/akane-note/🌎数据库/MySQL/images/redolog.png)

有了 redo log，InnoDB 就可以保证即使数据库发生异常重启，之前提交的记录都不会丢失，这个能力称为 crash-safe。



### Bin Log（归档日志）

就像上面例子中的账本，记录的比较详细，是server层的日志。

**Binlog有两种模式，statement 格式的话是记sql语句， row格式会记录行的内容，记两条，更新前和更新后都有。**





### Bin Log与Redo Log区别

1. redo是**innodb**独有的，binlog是所有引擎都可以使用的

2. redo是物理日志，记录的是在某个数据页上**做了什么修改**，binlog是逻辑日志，记录的是这个语句的**原始逻辑**

3. redo是**循环**写的，空间会用完，binlog是可以**追加**写的，不会覆盖之前的日志信息



### 两阶段提交

![两阶段提交.png](images/两阶段提交.png)





Undo Log：Undo Log是为了实现事务的原子性，在MySQL数据库InnoDB存储引擎中，还用Undo Log来实现多版本并发控制(简称：MVCC)

注意：undo log是逻辑日志，可以理解为：

– 当delete一条记录时，undo log中会记录一条对应的insert记录

– 当insert一条记录时，undo log中会记录一条对应的delete记录

– 当update一条记录时，它记录一条对应相反的update记录

