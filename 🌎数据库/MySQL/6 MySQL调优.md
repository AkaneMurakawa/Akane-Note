# MySQL调优



## 查询慢的原因

- 网络
- CPU
- IO
- 上下文切换
- 系统调用
- 生成统计信息
- 锁等待时间



## 数据类型优化

1. 尽量避免null，数据库中null不等于null，并且对于存在索引的地方也有很复杂。因此建议最后设计为非null
2. 合理使用范式和反范式，适当冗余
3. 不要查询不需要的数据，优化方式：加limit
4. 不需要的字段不要查出来，尤其是多表关联时候，把select *会影响性能
5. **更新频繁**（删除或更新可能造成页分裂和页合并），区分度不高的，不宜建索引
6. 使用函数不会走索引
7. 区分度高的放最前面，最左前缀原则
8. 如果明确知道只有一条结果返回，limit能够提高效率（减少判断）
9. 推荐使用代理主键，自然主键与业务耦合，不适合维护





## 业务优化

1、减少数据库访问次数（如增加缓存，单个查询改为批量查询，但需要注意的是，批量查询注意分批，一次性数据太多可能会导致查询不出来）



## MySQL优化器优化

1.  重新定义关联表的顺序
2. 将外连接转化成内连接，内连接的效率要高于外连接
3. 使用等价变换规则，mysql可以使用一些等价变化来简化并规划表达式
4. 优化count(),min(),max()。索引和列是否可以为空通常可以帮助mysql优化这类表达式：例如，要找到某一列的最小值，只需要查询索引的最左端的记录即可，不需要全文扫描比较
5. 预估并转化为常数表达式（conf），当mysql检测到一个表达式可以转化为常数的时候，就会一直把该表达式作为常数进行处理
6. 索引覆盖扫描，当索引中的列包含所有查询中需要使用的列的时候，**可以使用覆盖索引**
7. 子查询优化。MySQL在某些情况下可以将子查询转换一种效率更高的形式，从而减少多个查询多次对数据进行访问，例如将经常查询的数据放入到缓存中
8. 等值传播。如果两个列的值通过等式关联，那么MySQL能够把其中一个列的where条件传递到另一个上



## 开启慢查询日志

查询系统当前慢查询配置

```mysql
SHOW VARIABLES LIKE 'slow_query%';

SHOW VARIABLES LIKE 'long_query_time';
```



在MySQL配置文件中，新增以下配置（注：修改完配置重启即可生效）

```
slow_query_log= 1 # 慢查询开启状态
slow_query_log_file= /usr/local/mysql/data/slow-query.log # 慢查询日志存放的位置（一般设置为 MySQL 的数据存放目录）
long_query_time=10 # 查询超过多少秒才记录
```



测试

```mysql
mysql> select sleep(11);
```

如果是windows，文件默认是C:\ProgramData\MySQL\MySQL Server 5.7\Data，我们可以打开文件看一下内容，可以看到能够知道查询的用户，查询时间，SQL内容等信息。

```log
# Time: 2020-10-22T03:40:23.463303Z
# User@Host: root[root] @ localhost [::1]  Id:     8
# Query_time: 11.017508  Lock_time: 0.000000 Rows_sent: 1  Rows_examined: 0
use test;
SET timestamp=1603338023;
select sleep(11);
```

